# Always Encrypted with Secure Enclaves

As you've learned, Always Encrypted (first introduced in SQL Server 2016) allows sensitive data to be encrypted within the database without exposing the encryption keys to the database engine. However, we have also observed some key limitations in its implementation:

- **Cryptography Operations**: The necessity for data to make a round trip from the server to the client for cryptographic operations, such as encryption and decryption, significantly impedes the ability to encrypt large volumes of data at scale. This limitation can become a bottleneck for applications requiring high-performance encryption and decryption of data in bulk.

- **Query Limitations**: The query capabilities on encrypted data are severely restricted. To query encrypted data, you first have to compromise security by choosing deterministic encryption over randomized encryption. And even then, SQL Server only supported basic equality matching with deterministic encryption, with no ability to execute range queries or wildcard queries using the `LIKE` operator.

## Introducing Secure Enclaves

To address these limitations, SQL Server 2019 introduced a groundbreaking feature, Always Encrypted with Secure Enclaves.

A secure enclave is a protected region of memory within the SQL Server process on the server machine that provides a safe space for cryptographic operations over sensitive data. The enclave acts as a "black box" within the server, inaccessible to the server's operating system or any administrative user. The contents of the enclave are not even revealed in the crash dump generated by a catastrophic server failure. This isolation ensures that even if the server is compromised, the data within the enclave remains protected. The client machine, which has a high level of trust in the enclave, injects special code and the Column Master Key (CMK) into the enclave, enabling the encryption and decryption of data within this secure environment. Thus, you can think of the enclave as "a piece of the client that runs on the server machine."

> **The Embassy Analogy:** Imagine a secure enclave as an embassy located in a foreign country. Being inside the embassy is akin to being in the territory of the country that owns the embassy, though that country may be located thousands of miles away. But stepping outside the perimeter of the embassy immediately places you in the foreign country's jurisdiction — potentially hostile territory. However, the enclave (or embassy) allows for secure operations (or safe haven) within the foreign environment, without the need to travel back to the home country. Comparatively, traveling thousands of miles represents the high latency incurred by data having to round-trip between the client and the server for encryption or decryption operations. The secure enclave, therefore, eliminates the need for extensive network round-trips in order to perform cryptography (encryption and decryption) tasks.

This technology addresses the aforementioned challenges by:

- **Eliminating Round Trips**: By performing encryption and decryption operations inside the secure enclave on the server machine, SQL Server eliminates the need for round trips across the network between the client and server machines. This enables support for "in-place encryption," and dramatically improves the performance and scalability of cryptographic operations.

- **Enabling Complex Queries**: The secure enclave allows SQL Server to delegate parts of a query that require access to decrypted data to the enclave. This capability means that it is now possible to perform operations on randomly encrypted columns, including range queries and wildcard matching using the `LIKE` operator. Essentially, it brings a piece of the client-side trust into the server, enabling the server to perform client-level encryption and decryption operations in a way that the server itself cannot access the unencrypted data.

## Enable Virtualization-Base Security (VBS)

```powershell
Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard -Name EnableVirtualizationBasedSecurity -Value 1
```

```powershell
Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard -Name RequirePlatformSecurityFeatures -Value 0
```

```powershell
Restart-Computer
```

## Enable Always Encrypted with Secure Enclaves in SQL Server

```sql
-- Connect WITHOUT enabling AE in the connection string

-- Set the secure enclave type to virtualization based security (VBS).
EXEC sys.sp_configure 'column encryption enclave type', 1
RECONFIGURE

-- Restart SQL Server instance (?)

-- Confirm the secure enclave is now loaded
SELECT
    name,
    description,
    value,
    value_in_use
FROM
    sys.configurations
WHERE
    name = 'column encryption enclave type'
```

## Populate the Sample Database

```sql
CREATE DATABASE MyEncryptedDB
GO

USE MyEncryptedDB
GO

DROP TABLE IF EXISTS Customer
GO

CREATE TABLE Customer(
    CustomerId  int IDENTITY PRIMARY KEY,
    Name        varchar(20),
    SSN         varchar(20),
    Salary      money,
    City        varchar(20)
)

INSERT INTO Customer
 (Name,             SSN,            Salary,    City) VALUES
 ('James Miller',   '123-45-6789',  61692,    'New York'),      -- > 60000 Same salary as Greg Stevens
 ('Doug Nichols',   '987-65-4321',  59415,    'Boston'),        -- < 60000
 ('Richard Jones',  '346-90-5513',  50698,    'Chicago'),       -- < 60000
 ('Joe Anonymous',  'n/a',          54036,    'Los Angeles'),   -- < 60000
 ('Greg Stevens',   '555-43-7801',  61692,    'Seattle')        -- > 60000 Same salary as James Miller

SELECT * FROM Customer
GO
```

## Provision Enclave-Enabled Keys

```sql
-- CMK1 & CEK1
```

## Encrypt Columns In-Place

```sql
-- Connect WITH enabling AE in the connection string (enable secure enclaves, protocol: none)

USE MyEncryptedDB
GO

ALTER TABLE Customer 
 ALTER COLUMN SSN varchar(20)
 COLLATE Latin1_General_BIN2
 ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = CEK1, ENCRYPTION_TYPE = Randomized, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256') NOT NULL
 WITH (ONLINE = ON)

ALTER TABLE Customer
 ALTER COLUMN Salary money
 ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = CEK1, ENCRYPTION_TYPE = Randomized, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256') NOT NULL
 WITH (ONLINE = ON)

-- Notice the ALTER DATABASE SCOPED CONFIGURATION CLEAR PROCEDURE_CACHE statement to clear the query plan cache for the database
-- in the above script. After you have altered the table, you need to clear the plans for all batches and stored procedures that
-- access the table, to refresh parameters encryption information.
ALTER DATABASE SCOPED CONFIGURATION CLEAR PROCEDURE_CACHE

SELECT * FROM Customer        
GO

-- and then again with AE disabled in the connection string, just to prove it's encrypted
USE MyEncryptedDB
GO
SELECT * FROM Customer        -- and then again with AE disabled in the connection string, just to prove it's encrypted
GO

-- re-enable AE in the connection string
USE MyEncryptedDB
GO
```

## Run Rich Queries Against Encrypted Columns

```sql
DECLARE @SsnPattern varchar(20) = '%5513'
DECLARE @MinSalary money = 60000

SELECT
    *
FROM
    Customer
WHERE
    SSN LIKE @SSNPattern OR
    Salary >= @MinSalary
```

## Cleanup

_content_

## Additional Information

Always Encrypted with Secure Enclaves is an advanced feature, with much more to explore beyond what we've covered in this lab. There are additional complexities that you will need to learn about, if you want to deploy this capability to live production environments. Specifically, you will want to understand the different types of supported enclaves, the role of attestation, and how to properly setup an environment with secure enclaves.

**Types of Enclaves**

SQL Server supports both Virtualization-Based Security (VBS) enclaves and hardware-based enclaves, including Intel Software Guard Extensions (SGX), offering enhanced security for cryptographic operations within the database and enabling more complex querying on encrypted data.

**The Role of Attestation**

Attestation servers or cloud-based attestation services play a crucial role in ensuring the trustworthiness of the secure enclave. They attest to the client machine that the server's enclave is secure and can be trusted to perform sensitive cryptographic operations. Once trust is established, the client can provide the enclave with the CMK via a secure tunnel, enabling secure operations directly on the server machine without the need for high-latency network traffic.

To simplify the setup for educational purposes, this lab did not use an attestation server. However, it's important to note that real-world production applications should employ attestation to ensure the highest level of security.

**Setting Up an Environment with Secure Enclaves**

Implementing Always Encrypted with secure enclaves requires a specific setup involving a database server configured to use Always Encrypted with secure enclaves and an attestation server to establish trust.


**Learn More**

To learn more, visit the Microsoft documentation on Always Encrypted with Secure Enclaves at https://learn.microsoft.com/sql/relational-databases/security/encryption/always-encrypted-enclaves.