# Always Encrypted with Secure Enclaves

As you've learned, Always Encrypted (first introduced in SQL Server 2016) allows sensitive data to be encrypted within the database without exposing the encryption keys to the database engine. However, we have also observed some key limitations in its implementation:

- **Cryptography Operations**: The necessity for data to make a round trip from the server to the client for cryptographic operations, such as encryption and decryption, significantly impacts the ability to encrypt large volumes of data at scale. This limitation can become a bottleneck for applications requiring high-performance encryption and decryption of data in bulk.

- **Query Limitations**: The query capabilities on encrypted data are severely restricted. To query encrypted data, you first havae to compromise security by choosing deterministic encryption over randomized encryption. And even then, SQL Server only supported basic equality matching with deterministic encryption, with no ability to execute range queries or wildcard queries using the `LIKE` operator.

## Introducing Secure Enclaves

To address these limitations, SQL Server 2019 introduced a groundbreaking feature, Always Encrypted with Secure Enclaves. A secure enclave is a protected region of memory on the server that provides a safe space for cryptographic operations on sensitive data. This technology addresses the key challenges by:

- **Eliminating Round Trips**: By performing encryption and decryption operations inside the secure enclave on the server, SQL Server eliminates the need for round trips between the server and the client. This enables support for "in-place encryption," and dramatically improves the performance and scalability of cryptographic operations.

- **Enabling Complex Queries**: The secure enclave allows SQL Server to delegate parts of a query that require access to decrypted data to the enclave. This capability means that it is now possible to perform operations on randomly encrypted columns, including range queries and wildcard matching using the `LIKE` operator. Essentially, it brings a piece of the client-side trust into the server, enabling the server to perform client-level encryption and decryption operations in a way that the server itself cannot access the unencrypted data.

## Understanding Enclaves

A secure enclave is a protected region of memory within the SQL Server process. The enclave acts as a "black box" within the server, inaccessible to the server's operating system or any administrative user. This isolation ensures that even if the server is compromised, the data within the enclave remains protected. The client machine, which has a high level of trust in the enclave, injects special code and the Column Master Key (CMK) into the enclave, enabling the encryption and decryption of data within this secure environment.

> **The Embassy Analogy:** Imagine a secure enclave as an embassy located in a foreign country. Being inside the embassy is akin to being in the territory of the country that owns the embassy, surrounded by a protected environment. Stepping out of the embassy places you in the foreign country's jurisdiction — potentially hostile territory. However, the enclave (or embassy) allows for secure operations (or safe haven) within the foreign environment without the need to travel back to the home country. Comparatively, traveling thousands of miles represents the high latency incurred by data having to round-trip between the client and the server for encryption or decryption operations. The secure enclave, thus, acts as "a piece of the client on the server machine," eliminating the need for extensive network round-trips and significantly enhancing data operation efficiency.


SQL Server supports both Virtualization-Based Security (VBS) enclaves and hardware-based enclaves, including Intel Software Guard Extensions (SGX), offering enhanced security for cryptographic operations within the database and enabling more complex querying on encrypted data. For detailed information, please refer to the [Microsoft documentation on Always Encrypted with Secure Enclaves](https://learn.microsoft.com/sql/relational-databases/security/encryption/always-encrypted-enclaves).

## The Role of Attestation

Attestation servers or cloud-based attestation services play a crucial role in ensuring the trustworthiness of the secure enclave. They attest to the client machine that the server's enclave is secure and can be trusted to perform sensitive cryptographic operations. To simplify the setup for educational purposes, this lab will not use an attestation server. However, it's important to note that real-world production applications should employ attestation to ensure the highest level of security.

### Next Steps

With this foundational understanding of Always Encrypted with Secure Enclaves, we'll move on to the hands-on lab exercises to explore how these concepts are applied in practical scenarios. The labs will guide you through setting up and using Always Encrypted with Secure Enclaves, providing a hands-on experience with this powerful security feature.


Secure enclaves represent an advanced feature of Always Encrypted introduced in SQL Sever 2019 and enhanced in SQL Server 2022, aimed at overcoming some of the limitations of its basic implementation introduced in SQL Server 2016. While our previous labs have not covered this topic hands-on due to its complexity, understanding secure enclaves is crucial for realizing the full potential of Always Encrypted in SQL Server.

## What Are Secure Enclaves?

A secure enclave is a protected region of memory within the SQL Server process, designed to perform computations on encrypted data. This secure area ensures that data and the operations performed on it are protected from the rest of the system, including SQL Server itself. The use of secure enclaves extends the capabilities of Always Encrypted by allowing more complex operations to be securely performed on encrypted data.

The server machine, even the kernel on the server machine, has no access to the region of memory designated as the secure enclave. This strict isolation ensures that even the most privileged processes on the server cannot view or interfere with the operations within the enclave. Furthermore, in the event of a system crash, the contents of the enclave are not revealed in crash dumps, safeguarding the confidentiality of sensitive operations and data within the enclave.

## The Embassy Analogy

Imagine a secure enclave as an embassy located in a foreign country. Being inside the embassy is akin to being in the territory of the country that owns the embassy, surrounded by a protected environment. Stepping out of the embassy places you in the foreign country's jurisdiction — potentially hostile territory. However, the enclave (or embassy) allows for secure operations (or safe haven) within the foreign environment without the need to travel back to the home country. Comparatively, traveling thousands of miles represents the high latency incurred by data having to round-trip between the client and the server for encryption or decryption operations. The secure enclave, thus, acts as "a piece of the client on the server machine," eliminating the need for extensive network round-trips and significantly enhancing data operation efficiency.

## Additional Security Measures of Secure Enclaves

The server machine, even the kernel on the server machine, has no access to the region of memory designated as the secure enclave. This strict isolation ensures that even the most privileged processes on the server cannot view or interfere with the operations within the enclave. Furthermore, in the event of a system crash, the contents of the enclave are not revealed in crash dumps, safeguarding the confidentiality of sensitive operations and data within the enclave.

## Overcoming Limitations of Basic Always Encrypted

The primary implementation of Always Encrypted, as explored in our labs, encrypts data within client applications before sending it to the database. This approach, while secure, limits the types of operations that can be performed on encrypted columns. For example, it supports exact matches on deterministically encrypted data but cannot handle queries that require pattern matching or range comparisons on encrypted columns.

## Key Benefits of Secure Enclaves

Secure enclaves address these limitations by enabling:

- **In-Place Encryption and Decryption:** Data can be encrypted or decrypted directly within the enclave, akin to stepping into the embassy to conduct sensitive operations securely.
  
- **Advanced Query Capabilities:** With secure enclaves, SQL Server can perform operations on randomly encrypted data that were previously not possible, such as range queries, wildcard matching, and pattern matching. This is achieved by securely decrypting the data inside the enclave, performing the operation, and then re-encrypting the result if necessary.

- **Delegated Cryptography Operations:** The query processor can delegate portions of the query that require cryptographic operations to the enclave, allowing for complex queries on encrypted data while maintaining the confidentiality and integrity of the data.

## Trust Establishment via Attestation Server

For a client to trust a secure enclave, an attestation process is required, akin to verifying the authenticity and safety of an embassy before stepping inside. This involves an attestation server, which verifies the identity and integrity of the secure enclave before allowing the client to perform cryptographic operations within it. Once trust is established, the client can provide the enclave with the CMK via a secure tunnel, enabling secure operations directly on the server without the need for high-latency network traffic.

## Setting Up an Environment with Secure Enclaves

Implementing Always Encrypted with secure enclaves requires a specific setup involving a database server configured to use Always Encrypted with secure enclaves and an attestation server to establish trust. For more detailed information on setting up an environment that leverages Always Encrypted with secure enclaves, refer to the official Microsoft documentation:

[Always Encrypted with secure enclaves](https://docs.microsoft.com/en-us/sql/relational-databases/security/encryption/always-encrypted-enclaves?view=sql-server-ver15)

This guide provides a comprehensive overview of secure enclaves, including how to configure your environment, set up an attestation server, and enable advanced cryptographic operations within your SQL Server databases.





















# Stuff

Configuring Always Encrypted with Secure Enclaves without using the Always Encrypted Wizard, and instead creating a Column Master Key (CMK) directly from the SSMS Object Explorer, involves a series of steps. Here's how to do it on a development machine running SQL Server 2022 on Windows 10, assuming the use of Virtualization-Based Security (VBS) instead of SGX:

### 1. Prerequisites

Ensure your system meets the necessary requirements:
- Windows 10, up to date.
- SQL Server 2022 or later.
- A processor supporting virtualization extensions and MBEC.
- Administrator access on your machine.

### 2. Enable Hyper-V and Windows Defender Application Guard

1. Open **Control Panel** > **Programs** > **Programs and Features**.
2. Click **Turn Windows features on or off**.
3. Check **Hyper-V** and **Windows Defender Application Guard**, click **OK**, then reboot if prompted.

### 3. Enable and Configure VBS

1. Run `gpedit.msc` to open the **Group Policy Editor**.
2. Go to **Computer Configuration** > **Administrative Templates** > **System** > **Device Guard**.
3. Enable **Turn On Virtualization Based Security**:
   - Set to **Enabled**.
   - Choose **Secure Boot** under **Select Platform Security Level**.
   - Enable **Use Virtualization Based Protection of Code Integrity** with **Enabled without lock**.
4. Reboot your system.

### 4. Configure SQL Server for Always Encrypted with Secure Enclaves

#### Create Column Master Key (CMK) Using SSMS

1. Open **SQL Server Management Studio (SSMS)** and connect to your database instance.
2. In the **Object Explorer**, expand **Databases**, then your database.
3. Right-click on **Security**, go to **New**, and select **New Column Master Key**.
4. Give your CMK a name.
5. Choose the location to store the CMK. For development purposes, you can select **Windows Certificate Store - Current User**.
6. Click **OK** to create the CMK.

#### Create Column Encryption Key (CEK)

1. Right-click on **Security**, navigate to **New**, and then choose **Column Encryption Key**.
2. Provide a name for your CEK.
3. Select the CMK you created from the drop-down menu.
4. Click **OK**.

#### Create or Alter Table for Always Encrypted with Secure Enclaves

1. Use T-SQL to create a new table or alter an existing one to use encrypted columns. For a new table:

   ```sql
   CREATE TABLE Employees (
       Id INT PRIMARY KEY,
       Name NVARCHAR(50),
       Salary INT ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = [YourCEKName], ENCRYPTION_TYPE = RANDOMIZED, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256')
   );
   ```

   For an existing table:

   ```sql
   ALTER TABLE Employees
   ADD Salary_Encrypted INT ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = [YourCEKName], ENCRYPTION_TYPE = RANDOMIZED, ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256');
   ```

   Replace `[YourCEKName]` with the name of your Column Encryption Key.

### 5. Configure Your Application Connection String

Ensure your application's connection string includes `Column Encryption Setting=Enabled`. This is essential for the application to interact with encrypted columns correctly.

### 6. Disable Attestation (If Required)

Since you're working without an attestation server, make sure your configuration reflects this. The setup might vary, so adjust according to your specific situation, focusing on the enclave and encryption settings in SQL Server and your application.

### 7. Validate Your Setup

Test your setup by performing operations (insert, update, select) on the encrypted columns. Monitor for any errors or warnings in the SQL Server error log and Windows Event Viewer related to your setup.

This approach involves more manual steps and requires a good understanding of SQL Server's encryption features, but it offers more control over the encryption process and configurations.
