# Always Encrypted with Secure Enclaves

As you've learned, Always Encrypted (first introduced in SQL Server 2016) allows sensitive data to be encrypted within the database without exposing the encryption keys to the database engine. However, we have also observed some key limitations in its implementation:

- **Cryptography Operations**: The necessity for data to make a round trip from the server to the client for cryptographic operations, such as encryption and decryption, significantly impedes the ability to encrypt large volumes of data at scale. This limitation can become a bottleneck for applications requiring high-performance encryption and decryption of data in bulk.

- **Query Limitations**: The query capabilities on encrypted data are severely restricted. To query encrypted data, you first have to compromise security by choosing deterministic encryption over randomized encryption. And even then, SQL Server only supported basic equality matching with deterministic encryption, with no ability to execute range queries or wildcard queries using the `LIKE` operator.

## Introducing Secure Enclaves

To address these limitations, SQL Server supports Always Encrypted with Secure Enclaves, a groundbreaking feature first introduced in SQL Server 2019 and later enhanced in SQL Server 2022.

A secure enclave is a protected region of memory within the SQL Server process on the server machine that provides a safe space for cryptographic operations over sensitive data. The enclave acts as a "black box" within the server, inaccessible to the server's operating system or any administrative user. The contents of the enclave are not even revealed in the crash dump generated by a catastrophic server failure. This isolation ensures that even if the server is compromised, the data within the enclave remains protected. The client machine, which has a high level of trust in the enclave, injects special code along with the Column Encryption Key (CEK) into the enclave, enabling the encryption and decryption of data within this secure environment. Thus, you can think of the enclave as "a piece of the client that runs on the server machine."

> **The Embassy Analogy:** Imagine a secure enclave as an embassy located in a foreign country. Being inside the embassy is akin to being in the territory of the country that owns the embassy, though that country may be located thousands of miles away. But stepping outside the perimeter of the embassy immediately places you in the foreign country's jurisdiction — potentially hostile territory. However, the enclave (or embassy) allows for secure operations (or safe haven) within the foreign environment, without the need to travel back to the home country. Comparatively, traveling thousands of miles represents the high latency incurred by data having to round-trip between the client and the server for encryption or decryption operations. The secure enclave, therefore, eliminates the need for extensive network round-trips in order to perform cryptography (encryption and decryption) tasks.

This technology addresses the aforementioned challenges by:

- **Eliminating Round Trips**: By performing encryption and decryption operations inside the secure enclave on the server machine, SQL Server eliminates the need for round trips across the network between the client and server machines. This enables support for "in-place encryption," and dramatically improves the performance and scalability of cryptographic operations.

- **Enabling Complex Queries**: The secure enclave allows SQL Server to delegate parts of a query that require access to decrypted data to the enclave. This capability means that it is now possible to perform operations on randomly encrypted columns, including range queries and wildcard matching using the `LIKE` operator. Essentially, it brings a piece of the client-side trust into the server, enabling the server to perform client-level encryption and decryption operations in a way that the server itself cannot access the unencrypted data.

## Enable and Verify Virtualization-Based Security (VBS)

This lab relies on Virtualiation-Based Security (VBS), which uses hardware virtualization features to create and isolate a secure region of memory from the normal operating system which can server as a secure enclave for Always Encrypted. VBS relies on Microsoft’s Hyper-V hypervisor to run a secure kernel alongside the main operating system. This secure kernel handles sensitive operations and secures processes that the normal operating system cannot directly access.

1. **Verify VBS and Preliminary Requirements:**
   - Open the **Run** dialog by pressing `Win + R`.
   - Type `msinfo32.exe` and press **Enter**. This opens the System Information window.
   - In the System Information window, navigate to **System Summary**. Look for the **Virtualization-Based Security** setting to see if it is listed as **Running**. If it is, then you're all set and you can advance to the next step (Enable Always Encrypted with Secure Enclaves in SQL Server).

2. **Enable VBS:**
   - If VBS is not running, open PowerShell as an administrator:
     - Search for PowerShell in the Start menu, right-click on it, and select **Run as administrator**.
   - Execute the following command to enable Virtualization-Based Security:
     ```powershell
     Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard -Name EnableVirtualizationBasedSecurity -Value 1
     ```

3. **Check UEFI Secure Boot or IOMMU Support:**

   VBS uses capabilities like UEFI (Unified Extensible Firmware Interface) Secure Boot and IOMMU (Input-Output Memory Management Unit) to create and manage secure, isolated regions of memory from the normal operating system. If your machine does not support UEFI Secure Boot or is not equipped with an IOMMU, it is still possible to enable VBS, but with relaxed security settings

   - Still in the System Information window, check the **Secure Boot State**. If it states **On**, your machine has UEFI Secure Boot enabled, you don't need to check for IOMMU support.
   
   - If your machine doesn't have UEFI Secure Boot enabled, check **Device Manager** to see if it has IOMMU support.
     
     - Right-click on the **Start** button and select **Device Manager**.
     - Expand the **System Devices** section and look for entries like **Intel(R) Virtualization Technology for Directed I/O (VT-d)** or **AMD I/O Memory Management Unit**. Presence of these indicates IOMMU support.


   - If the **Secure Boot State** is **Off** or **Unsupported**, and if there is no IOMMU support, relax the platform security feature requirements for VBS:
     ```powershell
     Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard -Name RequirePlatformSecurityFeatures -Value 0
     ```

4. **Reboot the Computer:**
   - To apply the changes, reboot your computer by executing:
     ```powershell
     Restart-Computer
     ```
   - Once the system restarts, run `msinfo32.exe` once more to ensure that Virtualization-Based Security is now running.

## Enable Always Encrypted with Secure Enclaves in SQL Server

Now we need to enable the feature in SQL Server.

1. **Open a New SQL Query Window:**

   In SQL Server Management Studio (SSMS), press `CTRL + N` to open a new query window.

2. **Disable Always Encrypted in the Connection String:**
   Before proceeding, ensure that the current connection is not configured to use Always Encrypted from a previous lab:
     - Right-click anywhere in the query window and select **Connection > Change Connection**.
     - In the **Connect to Database Engine** dialog box, click on the **Options >>** button.
     - Check the **Always Encrypted** tab to see if the **Enable Always Encrypted (column encryption)** checkbox is selected.
     - If the checkbox is selected, then deselected it now.
     - Click **Connect** to re-establish the connection with Always Encrypted disabled.
     - SSMS will switch to the `master` database. To continue working with our `MyEncryptedDB` database, switch back to it by selecting it from the database dropdown at the top of the query window.

3. **Enable Secure Enclave for Always Encrypted:**
   
   Execute the following commands in the query window to set the secure enclave type to Virtualization-Based Security (VBS):
     ```sql
     EXEC sys.sp_configure 'column encryption enclave type', 1
     RECONFIGURE
     ```

   This command configures SQL Server to use a secure enclave for column encryption.

4. **Restart SQL Server Instance:**
     Changing the enclave configuration typically requires a restart of the SQL Server instance to apply changes. In the Object Explorer, right-click on your server instance and select **Restart**. Then click Yes to confirm the restart.

5. **Confirm Secure Enclave Configuration:**
   To verify that the secure enclave is correctly configured and loaded, execute the following query:

     ```sql
     SELECT
         name,
         description,
         value,
         value_in_use
     FROM
         sys.configurations
     WHERE
         name = 'column encryption enclave type'
     ```

   Ensure that both the **value** and **value_in_use** columns show a value of `1`. This confirms that the secure enclave is configured to use VBS.

## Populate the Sample Database

Now we can create our database and populate it with some sample data, similar to the sample database we worked with in the previous labs.

   1. Create a new database named `MyEncryptedDB` and switch to it:
   
      ```sql
      CREATE DATABASE MyEncryptedDB
      GO
  
      USE MyEncryptedDB
      ```
   
   2. Now, create a table named `Customer` with the same columns we used in our previous labs.
   
      ```sql
      CREATE TABLE Customer(
          CustomerId  int IDENTITY(1,1) PRIMARY KEY,
          Name        varchar(20),
          SSN         varchar(20),
          Salary      money,
          City        varchar(20)
      )
      ```

       Like our previous labs, we will encrypt the `SSN` and `Salary` columns in this table, except that this time, we will use secure enclaves. This will permit us to encrypt these columns in-place, without incurring the network latency of round-trips between the client and server machines. Furthermore, secure enclaves will allow us to use randomized encryption on both columns, and still perform rich operations on them (e.g., range queries, pattern matching).

   3. Insert sample records into the `Customer` table:
   
       ```sql
       INSERT INTO Customer
        (Name,             SSN,            Salary,    City) VALUES
        ('James Miller',   '123-45-6789',  61692,    'New York'),      -- > 60000  Same salary as Greg Stevens
        ('Doug Nichols',   '987-65-4321',  59415,    'Boston'),        -- < 60000
        ('Richard Jones',  '346-90-5513',  50698,    'Chicago'),       -- < 60000
        ('Joe Anonymous',  'n/a',          54036,    'Los Angeles'),   -- < 60000
        ('Greg Stevens',   '555-43-7801',  61692,    'Seattle')        -- > 60000  Same salary as James Miller
       ```

   4. Execute a query to ensure all records are correctly inserted and visible before encryption:
   
      ```sql
      SELECT * FROM Customer
      ```
   
      Naturally, nothing is encrypted yet, and all the data is visible in plain text.

## Provision Enclave-Enabled Keys

Now we can create the Column Master Key (CMK) and Column Encryption Key (CEK). Unlike our earlier lab where we used a wizard, this time we'll create the encryption keys directly via the Object Explorer. This is because secure enclaves will allow us to encrypt our columns in-place, without the assistance of the wizard and without the performance impact of expensive round-trips over the network between the client and server machines.


   - If at any step the option to "allow enclave computations" is not available, this indicates that the system does not meet the Virtualization-Based Security (VBS) requirements set out at the beginning of this lab.

1. **Create the Column Master Key (CMK):**
   - In the Object Explorer, expand the `MyEncryptedDB` database, navigate to **Security**, and right-click on **Always Encrypted Keys**. Select **New Column Master Key...**
   - In the dialog that appears, name the CMK as `CMK1`.
   - For **Key store**, select **Windows Certificate Store - Current User**.
   - Crucially, ensure the checkbox for **Allow enclave computations** is selected. If the checkbox is not visible, this indicates that the system does not meet the Virtualization-Based Security (VBS) requirements set out at the beginning of this lab.
   - Click **Generate Certificate** to create a new certificate for the new CMK, and save it in the user's certificate store.
   - Click **OK** to create the CMK.

3. **Create the Column Encryption Key (CEK):**
   - Still within the **Always Encrypted Keys** menu in Object Explorer, right-click and select **New Column Encryption Key...**
   - Name your CEK as `CEK1`, and select `CMK1` from the list of available master keys.
   - Ensure that the creation of the CEK is based on the CMK, which means it will also support enclave computations due to the properties inherited from the CMK.
   - Click **OK** to create the CEK.

## Perform In-Place Encryption of SSN and Salary Columns

Now we can encrypt the `SSN` and `Salary` columns in the `Customer` table using randomized encryption, leveraging secure enclaves for efficient in-place encryption.

1. **Enable Always Encrypted in the Connection String:**
     - Right-click anywhere in the query window and select **Connection > Change Connection**.
     - In the **Connect to Database Engine** dialog box, click on the **Options >>** button.
     - Select the **Always Encrypted** tab.
     - Select the **Enable Always Encrypted (column encryption)** checkbox.
     - Select the **Enable secure enclaves** checkbox.
     - Under **Enclave attestation**, set the **Protocal** to **None**.
     - Click **Connect** to re-establish the connection with Always Encrypted enabled.
     - SSMS will switch to the `master` database. To continue working with our `MyEncryptedDB` database, switch back to it by selecting it from the database dropdown at the top of the query window.

2. **Alter the Table for In-Place Encryption:**

   - Run the following SQL statements to encrypt the `SSN` and `Salary` columns:

     ```sql
     ALTER TABLE Customer 
       ALTER COLUMN SSN varchar(20)
         COLLATE Latin1_General_BIN2
         ENCRYPTED WITH (
           COLUMN_ENCRYPTION_KEY = CEK1,
           ENCRYPTION_TYPE = Randomized,
           ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256')
       WITH (ONLINE = ON)
     
     ALTER TABLE Customer
       ALTER COLUMN Salary money
         ENCRYPTED WITH (
           COLUMN_ENCRYPTION_KEY = CEK1,
           ENCRYPTION_TYPE = Randomized,
           ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256')
       WITH (ONLINE = ON)
     ```

3. **Clear the Query Plan Cache:**
   - To ensure the new encryption settings take immediate effect and clear any old execution plans that may have cached details of the unencrypted columns, execute:
     ```sql
     ALTER DATABASE SCOPED CONFIGURATION CLEAR PROCEDURE_CACHE
     ```

#### Explanation of the Code and Process:

- **In-Place Encryption:** The `ALTER TABLE` commands are used to modify the data type and encrypt the `SSN` and `Salary` columns directly within the database. This is done "in-place," meaning there is no need to move data out of the table or use additional resources to re-import it after encryption. This method is significantly more efficient than methods that require data migration (such as the wizard we used in our first lab), because the `WITH (ONLINE = ON)` clause allows operations to continue on the database while the encryption is applied.

- **Randomized Encryption:** Both columns are encrypted using randomized encryption, which is more secure than deterministic encryption because it ensures that the same values are encrypted to different ciphertexts. This reduces the risk of inference attacks based on pattern recognition in the encrypted data.

- **Secure Enclave Utilization:** Because the CEK is based on a CMK configured to allow enclave computations, the encryption process can utilize secure enclaves. This not only enhances security by isolating the encryption process from the rest of the SQL Server process but also allows for complex queries on randomly encrypted columns, such as range queries and pattern matching, which are not possible with traditional column-level encryption.

- **Clearing the Procedure Cache:** The command `ALTER DATABASE SCOPED CONFIGURATION CLEAR PROCEDURE_CACHE` is crucial after modifying encryption settings. It clears the query plan cache of the database, forcing SQL Server to recompile execution plans for subsequent queries. This ensures that any changes in encryption are recognized by the query optimizer, which might otherwise use cached plans that were optimized for accessing unencrypted data, leading to errors or suboptimal performance.

## Verify Encryption

To examine the data in its encrypted form, as stored in the database, let's disable Always Encrypted in our connection string, and run the query again:

1. **Query the table with Always Encrypted Enabled:**
   - Run this query to view all the rows in the the table:

     ```sql
     SELECT * FROM Customer
     ```

   - All of the encrypted data is revealed, because Always Encrypted is enabled in our connection string, and we have access to the CMK in our certificate store.

2. **Disable Always Encrypted in the Connection String:**
     - Right-click anywhere in the query window and select **Connection > Change Connection**.
     - In the **Connect to Database Engine** dialog box, click on the **Options >>** button.
     - Select the **Always Encrypted** tab.
     - Deselect the **Enable Always Encrypted (column encryption)** checkbox.
     - Click **Connect** to re-establish the connection with Always Encrypted disabled.
     - Select `MyEncryptedDB` from the the database dropdown at the top of the query window.

3. **Query the table with Always Encrypted Disabled:**
   - Run the same query to view all the rows in the the table:

     ```sql
     SELECT * FROM Customer
     ```

   - Now the encrypted data is no longer revealed, because Always Encrypted is disabled in our connection string.
   - Also observe that the encrypted values for the salary are different across all the rows, even between the identical salary values of 61692 for James Miller and Greg Stevens. This demonstrates how random encryption is more secure than deterministic encryption, which would result in the same encrypted value for both those customers.

4. **Re-enable Always Encrypted in the Connection String:**
     - Right-click anywhere in the query window and select **Connection > Change Connection**.
     - In the **Connect to Database Engine** dialog box, click on the **Options >>** button.
     - Select the **Always Encrypted** tab.
     - Select the **Enable Always Encrypted (column encryption)** checkbox.
     - Under **Enclave attestation**, ensure that the **Protocal** is set to **None**.
     - Click **Connect** to re-establish the connection without Always Encrypted ensabled.
     - Select `MyEncryptedDB` from the the database dropdown at the top of the query window.

## Run Rich Queries on Randomly Encrypted Columns

And now for the big payoff! Let's witness the powerful capability of secure enclaves to perform complex queries.

   - Run the following query:

     ```sql
     DECLARE @SsnPattern varchar(20) = '%5513'
     DECLARE @MinSalary money = 60000

     SELECT
         *
     FROM
         Customer
     WHERE
         SSN LIKE @SSNPattern OR
         Salary >= @MinSalary
     ```
   - This query demonstrates two advanced types of searches on encrypted columns: a wildcard pattern match on the SSN and a range query on the Salary.

- The query should return James Miller and Greg Stevens (who both have salaries above $60000), and Richard Jones (whose SSN matches the pattern), demonstrating the enclave's ability to process these conditions securely on encrypted data.

Note the following key takeaways from this exercise:

- **Secure Enclave Computations:**
  - The secure enclave provides a trusted execution environment within the server itself. This enclave can perform operations on encrypted data without decrypting it outside of the enclave's secure boundaries.
  - When you execute a query involving encrypted columns, the actual computation, such as checking if a salary is above a certain value or if an SSN matches a pattern, occurs inside the enclave.

- **Parameterization and Encryption:**
  - The query uses parameterization (i.e., `@SSNPattern` and `@MinSalary`) to ensure that the input values are securely passed to the server. The SQL Server engine then uses these parameters to perform computations inside the enclave.
  - Because the data and operations are confined to the enclave, SQL Server does not need to decrypt the data externally. This preserves the confidentiality and integrity of the data while still allowing complex queries.

- **Range Queries and Pattern Matching:**
  - **Range Query on Salary:** The secure enclave can evaluate which rows have a `Salary` greater than or equal to `$60000`, even though the `Salary` column is encrypted with randomized encryption.
  - **Wildcard Pattern Matching on SSN:** Similarly, the enclave can evaluate the pattern matching condition for the `SSN` field, identifying rows where the SSN ends with '5513'.

## Cleanup

_content_

## Additional Information

Always Encrypted with Secure Enclaves is an advanced feature, with much more to explore beyond what we've covered in this lab. There are additional complexities that you will need to learn about, if you want to deploy this capability to live production environments. Specifically, you will want to understand the different types of supported enclaves, the role of attestation, and how to properly setup an environment with secure enclaves.

**Types of Enclaves**

SQL Server supports both Virtualization-Based Security (VBS) enclaves and hardware-based enclaves, including Intel Software Guard Extensions (SGX), offering enhanced security for cryptographic operations within the database and enabling more complex querying on encrypted data.

**The Role of Attestation**

Attestation servers or cloud-based attestation services play a crucial role in ensuring the trustworthiness of the secure enclave. They attest to the client machine that the server's enclave is secure and can be trusted to perform sensitive cryptographic operations. Once trust is established, the client can provide the enclave with the CMK via a secure tunnel, enabling secure operations directly on the server machine without the need for high-latency network traffic.

To simplify the setup for educational purposes, this lab did not use an attestation server. However, it's important to note that real-world production applications should employ attestation to ensure the highest level of security.

**Setting Up an Environment with Secure Enclaves**

Implementing Always Encrypted with secure enclaves requires a specific setup involving a database server configured to use Always Encrypted with secure enclaves and an attestation server to establish trust.


**Learn More**

To learn more, visit the Microsoft documentation on Always Encrypted with Secure Enclaves at https://learn.microsoft.com/sql/relational-databases/security/encryption/always-encrypted-enclaves.