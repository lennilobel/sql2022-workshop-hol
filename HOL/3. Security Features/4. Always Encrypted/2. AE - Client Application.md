# Always Encrypted in Client Applications

In this lab, we transition from directly interacting with SQL Server to incorporating Always Encrypted into a real-world application scenario. You will develop a C# client application designed to interface with the `Customer` table we populated in the first lab. This hands-on experience will not only deepen your understanding of Always Encrypted but also showcase its practical application in software development.

Throughout this lab, we'll explore how Always Encrypted functions within the context of a client application, focusing on key operations such as inserting and querying data in the `Customer` table. A significant aspect of this lab involves the use of stored procedures. You'll learn how to create stored procedures that are compatible with Always Encrypted, ensuring that your application can insert new customer records and query existing ones while maintaining the confidentiality and integrity of sensitive data.

## Creating the Stored Procedures

Let's start by creating stored procedures for our client application to call. These procedures enable secure data operations within our database, interfacing directly with encrypted columns.

**Stored Procedure for Selecting Customers by SSN:**

```sql
CREATE OR ALTER PROCEDURE SelectCustomersBySsn
    @SSN varchar(20)
AS
BEGIN
    SELECT
        CustomerId,
        Name,
        Ssn,
        City
    FROM
        Customer
    WHERE
        SSN = @SSN
END
```

**Stored Procedure for Inserting a New Customer:**

```sql
CREATE OR ALTER PROCEDURE InsertCustomer
    @Name varchar(20),
    @SSN varchar(20),
    @City varchar(20),
    @CustomerId int OUTPUT
AS
BEGIN
    INSERT INTO Customer (Name, Ssn, City)
     VALUES (@Name, @Ssn, @City)
END
```

**Parameter Binding and Encryption:**

- **SelectCustomersBySsn:** When the `@SSN` parameter is used, SQL Server recognizes its direct correlation with the encrypted `SSN` column in the `Customer` table. This connection enables the ADO.NET provider to automatically encrypt the parameter value using the correct encryption type and key before it's sent in a query, ensuring the operation adheres to the security constraints defined by Always Encrypted.

- **InsertCustomer:** Similarly, for the `InsertCustomer` stored procedure, SQL Server understands the relationship between the `@Name`, `@SSN`, and `@City` parameters and their corresponding columns in the `Customer` table. Given that `Name` and `SSN` are encrypted columns, the server conveys to the client-side provider that `@Name` and `@SSN` parameters need to be encrypted according to their designated column encryption settings before the insert operation. The `@City` parameter, associated with a non-encrypted column, is sent as plain text.

This nuanced parameter binding plays a crucial role in Always Encrypted's architecture, ensuring that data remains encrypted in transit and at rest, only being decrypted by authorized client applications. It highlights the seamless and secure data flow between the client application and SQL Server, facilitated by stored procedures that respect and integrate with the encryption schema of the database. Through this approach, developers can maintain data confidentiality and integrity without the need for manual encryption or decryption processes, leaning on SQL Server and the ADO.NET provider to handle these complexities.

## Creating the Client Application



